# Задание T4: Тест-план для системы управления услугами

---

## **Условие задачи:**

- Имеется 2 сервиса: Сервис А и сервис B.
- Сервис А принимает REST запросы на:
    - Подключение услуги
    - Отключение услуги
    - Блокирование услуги
- Сервис А отправляет AMQP сообщения сервису B для выполнения операций.
- Сервис B выполняет операции и отправляет ответные AMQP сообщения о результате.
- Сервис А обеспечивает упорядочивание AMQP-команд, отправляемых на сервис B.
- Сервис А принимает запросы независимо от результатов взаимодействия с сервисом B.
- Взаимодействие с сервисом B осуществляется в отдельном потоке.
- Статус услуги изменяется только после получения положительного ответа от сервиса B.
- Сервис А не отправляет следующую команду, пока не получит ответ на предыдущую команду от сервиса B.

---

## **1. Тест-план**

### **1.1 Объект тестирования**
- **Сервис А**: REST API для управления услугами (подключение, отключение, блокирование)
- **Сервис B**: AMQP обработчик команд
- **Взаимодействие между сервисами**: AMQP очередь, гарантирующая порядок и доставку сообщений

### **1.2 Цели тестирования**
1. Проверить корректность работы REST API Сервиса А.
2. Проверить упорядочивание AMQP команд, отправляемых на Сервис B.
3. Проверить корректность изменения статуса услуги только после положительного ответа от Сервиса B.
4. Проверить обработку ошибок и негативных сценариев (ошибки Сервиса B, таймауты).
5. Проверить независимость приёма запросов от результатов взаимодействия с Сервисом B.
6. Проверить отсутствие отправки следующей команды до получения ответа на предыдущую.

### **1.3 Стратегия тестирования**

| Вид тестирования | Описание | Техники тест-дизайна |
| :--- | :--- | :--- |
| **Функциональное тестирование** | Проверка REST API Сервиса А | Эквивалентное разбиение, таблицы решений |
| **Интеграционное тестирование** | Проверка взаимодействия Сервиса А и B через AMQP | Сценарии взаимодействия |
| **Тестирование состояния и переходов** | Проверка изменения статуса услуги | Диаграмма состояний и переходов |
| **Тестирование параллелизма** | Проверка упорядочивания команд и обработки параллельных запросов | Параллельное выполнение |
| **Тестирование ошибок** | Проверка обработки ошибок Сервиса B, таймаутов | Предугадывание ошибок |
| **Нагрузочное тестирование** | Проверка очереди команд при высокой нагрузке | Нагрузочные сценарии |

### **1.4 Критерии начала тестирования**
- Получены форматы REST API и AMQP сообщений
- Доступно тестовое окружение
- Есть доступ к логам и мониторингу

### **1.5 Критерии завершения тестирования**
- Выполнены все тест-кейсы
- Проверены все сценарии ошибок
- Документированы баги

### **1.6 Риски и ограничения**

| Риск | Вероятность | Влияние | Меры по снижению |
| :--- | :--- | :--- | :--- |
| Отсутствие документации по форматам AMQP сообщений | Средняя | Высокое | Использовать сниффер AMQP или запросить документацию |
| Сложность эмуляции ошибок Сервиса B | Высокая | Среднее | Использовать заглушку Сервиса B с возможностью эмуляции ошибок |
| Проблемы с воспроизведением условий гонки | Средняя | Высокое | Использовать инструменты для контроля времени и порядка сообщений |

### **1.7 График работы**
| Этап | Длительность | Описание работ |
| :--- | :--- | :--- |
| Анализ требований и архитектуры | 1 день | Изучение REST API и AMQP взаимодействия |
| Настройка тестового окружения | 0.5 дня | Развертывание заглушек, настройка RabbitMQ |
| Создание тест-плана и кейсов | 1.5 дня | Документирование стратегии и тест-кейсов |
| Выполнение тестирования | 2 дня | Проверка всех сценариев через API и мониторинг AMQP |
| Анализ результатов и отчет | 1 день | Составление отчета, документация дефектов |
| **Общая длительность** | **6 рабочих дней** | |

### **1.8 Ресурсы**
- **Инструменты**: Postman/Insomnia, RabbitMQ Management UI, сниффер AMQP, логи.
- **Команда**: 1 тестировщик.
- **Окружение**: Тестовый стенд с Сервисом А, Сервисом B (или заглушками), RabbitMQ.

### 1.9 Отслеживание прогресса
Данный раздел будет заполняться по мере выполнения работ в ходе реального тестирования.

---

## **2. Верхнеуровневые тест-кейсы**

### **2.1 Функциональные тест-кейсы**

#### **TC-T4-01: Успешное подключение услуги**
- **Предусловия**: Услуга не подключена.
- **Шаги**:
    1. Отправить REST запрос на подключение услуги в Сервис А.
    2. Проверить, что Сервис А отправил AMQP сообщение в Сервис B.
    3. Сервис B обрабатывает сообщение и отправляет положительный ответ.
    4. Проверить, что Сервис А получил ответ и изменил статус услуги на "Подключена".
- **Ожидаемый результат**: Статус услуги изменен на "Подключена".

#### **TC-T4-02: Успешное отключение услуги**
- **Предусловия**: Услуга подключена.
- **Шаги**:
    1. Отправить REST запрос на отключение услуги в Сервис А.
    2. Проверить отправку AMQP сообщения в Сервис B.
    3. Сервис B обрабатывает и отправляет положительный ответ.
    4. Проверить изменение статуса услуги на "Отключена".
- **Ожидаемый результат**: Статус услуги изменен на "Отключена".

#### **TC-T4-03: Успешное блокирование услуги**
- **Предусловия**: Услуга подключена.
- **Шаги**:
    1. Отправить REST запрос на блокирование услуги в Сервис А.
    2. Проверить отправку AMQP сообщения в Сервис B.
    3. Сервис B обрабатывает и отправляет положительный ответ.
    4. Проверить изменение статуса услуги на "Заблокирована".
- **Ожидаемый результат**: Статус услуги изменен на "Заблокирована".

### **2.2 Тестирование обработки ошибок**

#### **TC-T4-04: Отрицательный ответ от Сервиса B**
- **Предусловия**: Услуга не подключена.
- **Шаги**:
    1. Отправить REST запрос на подключение услуги.
    2. Сервис B возвращает отрицательный ответ (ошибка выполнения).
    3. Проверить, что статус услуги НЕ изменился.
- **Ожидаемый результат**: Статус услуги остался прежним.

#### **TC-T4-05: Таймаут ожидания ответа от Сервиса B**
- **Предусловия**: Услуга не подключена.
- **Шаги**:
    1. Отправить REST запрос на подключение услуги.
    2. Сервис B не отвечает в течение таймаута.
    3. Проверить, что статус услуги НЕ изменился.
    4. Проверить, что система корректно обрабатывает таймаут (логи, повторные попытки или уведомление).
- **Ожидаемый результат**: Статус услуги не изменен, таймаут обработан.

#### **TC-T4-06: Некорректное AMQP сообщение от Сервиса B**
- **Предусловия**: Услуга не подключена.
- **Шаги**:
    1. Отправить REST запрос на подключение услуги.
    2. Сервис B отправляет некорректное сообщение (не соответствует контракту).
    3. Проверить обработку ошибки парсинга в Сервисе А.
- **Ожидаемый результат**: Сервис А обрабатывает ошибку (логирует, не меняет статус).

### **2.3 Тестирование упорядочивания команд**

#### **TC-T4-07: Последовательная отправка команд для одной услуги**
- **Предусловия**: Услуга не подключена.
- **Шаги**:
    1. Отправить запрос на подключение услуги.
    2. Не дожидаясь ответа, отправить запрос на отключение той же услуги.
    3. Проверить, что Сервис А НЕ отправил команду отключения до получения ответа на команду подключения.
    4. После ответа на подключение проверить отправку команды отключения.
- **Ожидаемый результат**: Команды отправляются строго последовательно.

#### **TC-T4-08: Параллельные запросы для разных услуг**
- **Предусловия**: Услуги У1 и У2 не подключены.
- **Шаги**:
    1. Параллельно отправить запросы на подключение У1 и У2.
    2. Проверить, что AMQP сообщения отправлены для обеих услуг.
    3. Проверить, что команды для разных услуг могут обрабатываться параллельно (если архитектура позволяет).
- **Ожидаемый результат**: Команды для разных услуг отправлены и обрабатываются.

### **2.4 Тестирование независимости приёма запросов**

#### **TC-T4-09: Отправка запроса при ожидании ответа от Сервиса B**
- **Предусловия**: Услуга не подключена, отправлен запрос на подключение (ждем ответа).
- **Шаги**:
    1. Отправить новый запрос на отключение услуги (до получения ответа на подключение).
    2. Проверить, что Сервис А принял запрос (вернул 200 OK или принял в обработку).
    3. Проверить, что команда отключения поставлена в очередь и будет отправлена после получения ответа на подключение.
- **Ожидаемый результат**: Запрос принят, команда поставлена в очередь.

#### **TC-T4-10: Множество запросов на одну услугу**
- **Предусловия**: Услуга не подключена.
- **Шаги**:
    1. Быстро отправить несколько запросов на подключение услуги (например, 3 запроса).
    2. Проверить, что Сервис А поставил все команды в очередь.
    3. Проверить, что команды выполняются строго по очереди, каждая после ответа на предыдущую.
- **Ожидаемый результат**: Команды выполнены в порядке очереди.

### **2.5 Тестирование состояния услуги**

#### **TC-T4-11: Запрос статуса услуги во время обработки**
- **Предусловия**: Услуга не подключена, отправлен запрос на подключение.
- **Шаги**:
    1. Запросить текущий статус услуги через REST API (если есть такой метод).
    2. Проверить, что статус не изменился до получения ответа от Сервиса B.
- **Ожидаемый результат**: Статус остался "Не подключена".

#### **TC-T4-12: Изменение статуса только после успешного ответа**
- **Предусловия**: Услуга не подключена.
- **Шаги**:
    1. Отправить запрос на подключение.
    2. Мониторить статус услуги (например, через БД или API) до и после ответа от Сервиса B.
    3. Убедиться, что статус меняется только после получения положительного ответа.
- **Ожидаемый результат**: Статус изменен только после успешного ответа.

---

## **3. Матрица трассировки требований (RTM)**

| ID требования | Описание требования | ID тест-кейса |
| :--- | :--- | :--- |
| **REQ-T4-01** | Сервис А принимает REST запросы на подключение, отключение, блокирование | TC-T4-01, TC-T4-02, TC-T4-03 |
| **REQ-T4-02** | Сервис А отправляет AMQP сообщения сервису B | TC-T4-01, TC-T4-02, TC-T4-03 |
| **REQ-T4-03** | Статус услуги изменяется только после получения положительного ответа от Сервиса B | TC-T4-01, TC-T4-04, TC-T4-12 |
| **REQ-T4-04** | Сервис А обеспечивает упорядочивание AMQP-команд (не отправляет следующую, пока не получит ответ на предыдущую) | TC-T4-07, TC-T4-10 |
| **REQ-T4-05** | Сервис А принимает запросы независимо от результатов взаимодействия с Сервисом B | TC-T4-09 |
| **REQ-T4-06** | Обработка ошибок Сервиса B (отрицательный ответ, таймаут, некорректное сообщение) | TC-T4-04, TC-T4-05, TC-T4-06 |

---

## **4. Техники тест-дизайна**

| Техника | Описание применения | Примеры тест-кейсов |
| :--- | :--- | :--- |
| **Диаграмма состояний и переходов** | Моделирование состояний услуги (не подключена, подключена, заблокирована) и переходов между ними | Все позитивные тест-кейсы (TC-T4-01, TC-T4-02, TC-T4-03) |
| **Очередь и порядок обработки** | Проверка FIFO (First In, First Out) для команд одной услуги | TC-T4-07, TC-T4-10 |
| **Предугадывание ошибок** | Предположение о возможных ошибках Сервиса B, таймаутах | TC-T4-04, TC-T4-05, TC-T4-06 |
| **Параллельное выполнение** | Проверка обработки команд для разных услуг | TC-T4-08 |
| **Граничные значения** | Проверка обработки множества запросов, скорости отправки | TC-T4-10 |

---

## **5. Примечания и рекомендации**

### **Особенности тестирования T4:**
1. **Асинхронность**: Тестирование требует контроля за временем и порядком сообщений.
2. **Состояние услуги**: Важно проверять статус в БД или через API, чтобы убедиться в своевременном изменении.
3. **Упорядочивание**: Для одной услуги команды должны выполняться строго последовательно.
4. **Независимость приёма запросов**: Сервис А должен принимать запросы даже при ожидании ответа от Сервиса B, но команды ставятся в очередь.

### **Инструменты для тестирования:**
- **Заглушка Сервиса B**: Должна уметь эмулировать положительные/отрицательные ответы, таймауты, некорректные сообщения.
- **Мониторинг AMQP очереди**: RabbitMQ Management UI или аналоги для просмотра очередей.
- **Логи Сервиса А**: Для отслеживания внутренних процессов.

### **Рекомендации:**
1. Начать с тестирования позитивных сценариев.
2. Затем перейти к тестированию ошибок и таймаутов.
3. Проверить упорядочивание команд с помощью задержек ответов от Сервиса B.
4. Для тестирования параллельных запросов использовать инструменты вроде Apache JMeter или Postman Runner.
